<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SML Tests</title>
    <link rel="icon" href="https://icons.veryicon.com/png/o/healthcate-medical/mental-health-department-icon-library/clinical-laboratory.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" xintegrity="sha512-1ycn6IcaQQ40JDrFNgyyAuBuBFFbJQfVq/1R/cjrB6bQxNfKbcFqSgQv8xG4qA/rB2lqW/aR0hU/2+yT+s0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

    <style>
    /* Existing styles */
    .bg-gel { background-color: #bf0202; }
    .bg-edta { background-color: #78206d; }
    .bg-sodiumcitrate { background-color: #00b3f1; }
    .bg-plane { background-color: #FC4F00; }
    .bg-sodiumheparin { background-color: #8cdb73; }
    .bg-lithiumheparin { background-color: #176f21; }
    .bg-bigcup { background-color: #DC143C; }
    .bg-other { background-color: #7e7e7e; }

    body {
        font-family: 'Vazirmatn', sans-serif;
        display: d-flex; /* Corrected from d-flex */
        flex-direction: column;
        align-items: center; /* This will center items horizontally */
        min-height: 100vh;
        margin: 0;
    }

    .navbar {
        width: 100%;
        position: sticky;
        z-index: 1020;
    }

    .search-wrapper {
        width: 100%;
        max-width: 700px;
        padding: 0 15px;
        box-sizing: border-box;
        margin: 20px auto; /* Added 'auto' for horizontal centering */
    }

    .integrated-search-card {
        background-color: #fff;
        border: 1px solid #dfe1e5;
        border-radius: 30px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease-in-out;
        position: relative;
        width: 100%;
    }

    .integrated-search-card.expanded {
        border-bottom-left-radius: 30px;
        border-bottom-right-radius: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }

    #testSearch {
        width: 100%;
        padding: 12px 20px;
        padding-left: 45px;
        padding-right: 40px;
        border: none;
        border-radius: 30px;
        font-size: 16px;
        outline: none;
        background-color: transparent;
        box-sizing: border-box;
        text-align: left;
        z-index: 1;
    }

    #testSearch::placeholder {
        text-align: left;
    }

    #searchIcon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        z-index: 2;
    }

    #clearSearch {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #000;
        cursor: pointer;
        transition: color 0.3s ease;
        z-index: 2;
        display: none;
    }

    #clearSearch.visible {
        display: block;
    }

    #clearSearch:hover {
        color: #dc3545;
    }

    #suggestions {
        display: none; /* Initially hidden */
        max-height: 380px;
        overflow-y: auto;
        border-top: 1px solid #f0f0f0;
        margin-top: 5px;
        padding-top: 5px;
    }

    .integrated-search-card.expanded #suggestions {
        display: block; /* Show when expanded */
    }

    .suggestion-item {
        padding: 12px 20px;
        cursor: pointer;
        background: #ffffff;
        color: #343a40;
        border-bottom: 1px solid #eff2f5;
        transition: background 0.2s ease, color 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
        text-align: left;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background: #e9ecef;
    }


    .suggestion-item-row-1 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 4px;
    }

    .suggestion-item-row-2 {
        width: 100%;
    }

    .suggestion-item-row-1 strong {
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 1;
        padding-right: 10px;
    }
    .suggestion-item-row-2 small {
        color: #6c757d;
        font-style: italic;
        font-size: 0.8em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
    }

    .suggestion-info-pills {
        flex-shrink: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: flex-end;
        align-items: center;
    }
    .suggestion-info-pills .badge {
        font-size: 0.75em;
        padding: 0.3em 0.6em;
    }

    #suggestionsFooter {
        padding: 10px 20px;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        font-size: 0.85rem;
        color: #6c757d;
        text-align: center;
        margin-top: 0;
        border-radius: 0 0 30px 30px;
        display: none;
    }

    #singleCardContainer {
        width: 100%;
        max-width: 1000px; /* Adjust as needed */
        margin: 20px auto 80px auto; /* 'auto' for horizontal centering, existing top/bottom margins */
        border-radius: 20px;
    }

    .modal-body .inline-field {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }
    .modal-body .inline-field label {
        margin-bottom: 5px;
        font-weight: bold;
    }
    .modal-body .inline-field input {
        width: 100%;
    }
    .modal-body .d-flex .form-group {
        flex: 1;
    }


    @media (max-width: 992px) {
        .navbar-nav {
            flex-direction: row !important;
        }
        .navbar-nav .nav-item {
            margin-right: 15px;
            margin-bottom: 5px;
        }
         .navbar-nav .nav-item:hover {
            font-weight: bold;
            margin-right: 15px;
            margin-bottom: 5px;
        }
    }

    #unavailableTestsBadge {
        font-size: 0.8em;
        padding: .3em .6em;
        margin-left: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5em;
        height: 1.5em;
        border-radius: 50%;
        vertical-align: middle;
    }

    .popover-header {
        font-weight: bold;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .popover-body ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .popover-body li {
        padding: 0.25rem 0;
        cursor: pointer;
    }

    .popover-body li:hover {
        background-color: #e9ecef;
    }

    .popover-body hr {
        border-top: 1px solid #eee;
        margin: 0.5rem 0;
    }

    /* Styles for the access denied message overlay */
    .access-denied-message {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f8d7da;
        color: #721c24;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2em;
        text-align: center;
        z-index: 9999;
        flex-direction: column;
        gap: 20px;
    }
    .access-denied-message .icon {
        font-size: 3em;
        color: #dc3545;
    }
</style>
</head>
<body>
    <div id="accessDeniedOverlay" class="access-denied-message" style="display: none;">
        <i class="fas fa-times-circle icon"></i>
        <h1>Access Denied!</h1>
        <p>You do not have permission to view this page from your current IP address.</p>
        <p>Your IP: <span id="userIpDisplay">Loading...</span></p>
    </div>

    <div id="mainContent" style="display: none;">
        <div aria-hidden='true' aria-labelledby='birthdateModalLabel' class='modal fade' id='birthdateModal' tabindex='-1'>
            <div class='modal-dialog'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='birthdateModalLabel'>Calculate Your Birth Date</h5>
                        <button aria-label='Close' class='btn-close' data-bs-dismiss='modal' type='button'></button>
                    </div>
                    <div class='modal-body'>
                        <div class='mb-3' id='birthdateRow'>
                            <div class='inline-field'>
                                <label class='form-label' for='yearsInput'>Years: </label>
                                <input class='form-control' id='yearsInput' oninput='calculateBirthDate()' placeholder='Enter years' type='number'/>
                            </div>
                            <div class='inline-field'>
                                <label class='form-label' for='monthsInput'>Months: </label>
                                <input class='form-control' id='monthsInput' oninput='calculateBirthDate()' placeholder='Enter months' type='number'/>
                            </div>
                            <div class='inline-field'>
                                <label class='form-label' for='daysInput'>Days: </label>
                                <input class='form-control' id='daysInput' oninput='calculateBirthDate()' placeholder='Enter days' type='number'/>
                            </div>
                        </div>
                    </div>
                    <div class='modal-footer justify-content-center'>
                        <h3 class='font-weight-bold' id='birthDateResult'>0</h3>
                    </div>
                </div>
            </div>
        </div>

<!-- Discount Instructions Modal (New) -->
    <div class="modal fade"  tabindex="-1" aria-labelledby="discountModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="discountModalLabel">Discount Instructions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<div dir='rtl'>
                    <h5 style='display: block; margin: 0 0 30px;' >ڕێنمایى تایبەت بە پۆلێنکردنى سەرجەم ئەو کەسانەى کە داشکاندنەکانى تاوەرى تەندروستى سمارت دەیانگرێتەوە بەشێوەیەکى بەردەوام&#1548; وە لەم خشتەیەى خوارەوەدا شێوازى داشکاندنەکە دیارى کراوە.</h5> 
                    <ol>
                        <li>
                            گروپى A
                            <ul>
                                <li>دەستەى بەڕێوەبردنى تاوەرى تەندروستى سمارت</li>
                                <li>سەرجەم کلینیکى تاوەرەکە</li>
                            </ul>
                        </li>
                        <li>
                            گروپى B
                            <ul>
                                <li>ڕاوێژکار و هاوکارانى تاوەر</li>
                                <li>بەڕێوبەر و جێگرى بەڕێوبەرى بەش</li>
                            </ul>
                        </li>
                        <li>
                            گروپى C
                            <ul>
                                <li>سەرپەرشتیارەکان(سوپەرڤایسەرکان) &#1548; تیم لیدەر</li>
                            </ul>
                        </li>
                        <li>
                            گروپى D
                            <ul>
                                <li>سەرجەم کارمەندانى تاوەرى تەندروستى سمارت</li>
                                <li>چوار دراوسێى نزیکى تاوەرى تەندروستى سمارت</li>
                                <li>کەسى پلەیەکى گروپى (A , B) (دايك &#1548; باوك &#1548; هاوسەر &#1548; منداڵ &#1548; خوشک &#1548; برا)</li>
                            </ul>
                        </li>
                        <li>
                            گروپى E
                            <ul>
<li>کەسى پلەیەکى (D,C) (دايك &#1548; باوك &#1548; هاوسەر &#1548; منداڵ &#1548; خوشک &#1548; برا)</li>
                            </ul>
                        </li>
                    </ol>
</div>
                    <div class="table-responsive" dir='rtl'>
                        <table class="table table-striped table-bordered">
                            <thead class="bg-light">
                                <tr>
                                    <th scope="col">بەش</th>
                                    <th scope="col">گروپى A</th>
                                    <th scope="col">گروپى B</th>
                                    <th scope="col">گروپى C</th>
                                    <th scope="col">گروپى D</th>
                                    <th scope="col">گروپى E</th>
                                </tr>
                            </thead>
                            <tbody id="discountTableBody">
                                <!-- Table rows will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                <p>Published Date: 06-02-2025 No:25-0284 Rev 004</p>
                </div>
            </div>
        </div>
    </div>
    
        <div aria-hidden='true' aria-labelledby='discountModalLabel' class='modal fade' id='discountModal' role='dialog' tabindex='-1'>
            <div class='modal-dialog '>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='discountModalLabel'>Discount Calculator</h5>
                        <button aria-label='Close' class='btn-close' data-bs-dismiss='modal' type='button'></button>
                    </div>
                    <div class='modal-body'>
                        <form name='discountCalculator'>
                            <div class='form-group'>
                                <h6>Price</h6>
                                <input class='form-control' name='price' oninput='calculate()' required='' type='number'/>
                            </div>
                            <div class='form-group'>
                                <h6>Discount %</h6>
                                <input class='form-control' name='discount' oninput='calculate()' required='' type='number'/>
                            </div>
                            <div class='d-flex'>
                                <div class='form-group' style='padding: 5px;'>
                                    <h6>After Discount</h6>
                                    <input class='form-control' name='afterDiscount' readonly='' type='number'/>
                                </div>
                                <div class='form-group' style='padding: 5px;'>
                                    <h6>Discount Amount</h6>
                                    <input class='form-control' name='disamount' readonly='' type='number'/>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <nav class='navbar navbar-expand-lg bg-light sticky-top border-bottom'>
            <div class='container pl-4 justify-content-center'>
                <div class='row'>
                    <div class='container'>
                        <div class='d-flex'>
                            <ul class='navbar-nav'>
                                <li class='nav-item'>
                                    <a class='nav-link' href='#' id='birthdateModalTrigger'>Birthdate Calculator</a>
                                </li>
                                <li class='nav-item'>
                                    <a class='nav-link' href='#' id="discountInstructionsLink">Discount Instruction</a>
                                </li>
                                <li class='nav-item'>
                                    <a class='nav-link' href='#' id='discountModalTrigger'>Discount Calculator</a>
                                </li>
                                <li class='nav-item' id="unavailableTestsNavItem">
                                    <a class='nav-link' href='#' id='unavailableTestsPopoverTrigger'
                                       data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true"
                                       data-bs-title="Unavailable Tests" data-bs-content="Loading...">
                                        Unavailable Tests
                                        <span class="badge rounded-pill bg-danger ms-1 visually-hidden" id="unavailableTestsBadge">
                                            0
                                            <span class="visually-hidden">unavailable tests</span>
                                        </span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="search-wrapper">
            <div id="integratedSearchCard" class="integrated-search-card">
                <div class="search-input-wrapper">
                    <i id="searchIcon" class="fa fa-search"></i>
                    <input type="text" id="testSearch" placeholder="Start typing to search for tests." autocomplete="off"/>
                    <i id="clearSearch" class="fa fa-solid fa-xmark"></i>
                </div>
                <div id="suggestions">
                    </div>
                <div id="suggestionsFooter" class="suggestions-footer"></div>
            </div>
        </div>

        <div class="container" id="singleCardContainer">
            </div>

        <footer class='bg-body-tertiary fixed-bottom text-center border-top'>
            <div class='container'>
                © <script>document.write( new Date().getFullYear() );</script> <span>Developed by <a class='text-decoration-none' href='https://www.behance.net/volakurd' style='color: #373A40;' target='_blank'><b>R.V</b></a></span>
            </div>
        </footer>
    </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sheet URLs
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS46vORBn1D5ptlT5LbigOgdgBH6FQzQ550n4fJWHihp9SKXyiDJqkdkxt9yNIwrT-uKqPCSKlN_6Yx/pub?gid=0&single=true&output=csv';
        // Corrected URL for unavailable tests to match the user's original file
        const unavailableTestsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS46vORBn1D5ptlT5LbigOgdgBH6FQzQ550n4fJWHihp9SKXyiDJqkdkxt9yNIwrT-uKqPCSKlN_6Yx/pub?gid=2088118576&single=true&output=csv';
        // URL for allowed IPs from your Sheet4
        const allowedIPsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS46vORBn1D5ptlT5LbigOgdgBH6FQzQ550n4fJWHihp9SKXyiDJqkdkxt9yNIwrT-uKqPCSKlN_6Yx/pub?gid=1397779826&single=true&output=csv';

        let allData = [];
        let testNames = [];
        let unavailableTests = new Set(); // This set will now only track "Unavailable"
        let testStatus = new Map(); // Stores status like "Unavailable", "Sent Out"
        let allowedIPs = new Set();

        let unavailableTestsPopoverInstance = null;
        let birthdateModalInstance = null; // Added for manual modal control
        let discountModalInstance = null;   // Added for manual modal control

        // Function to fetch the user's public IP address
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error fetching IP address:', error);
                return null;
            }
        }

        // Function to fetch allowed IPs from Sheet4
        async function fetchAllowedIPs() {
            try {
                const response = await fetch(allowedIPsUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                // Assuming the first row contains headers and one of them is 'IP adress'
                const headers = rows[0].split(',').map(h => h.trim());
                // UPDATED: Changed 'IP Address' to 'IP adress' to match your sheet's column name
                const ipIndex = headers.indexOf('IP adress');

                if (ipIndex === -1) {
                    console.warn("'IP adress' column not found in allowed IPs sheet. Cannot restrict by IP.");
                    return;
                }

                rows.slice(1).forEach(row => {
                    const values = row.split(',');
                    const ip = values[ipIndex] ? values[ipIndex].trim() : '';
                    if (ip) {
                        allowedIPs.add(ip);
                    }
                });
                console.log("Allowed IPs Loaded from Sheet4:", Array.from(allowedIPs));
            } catch (error) {
                console.error('Error fetching allowed IPs CSV from Sheet4:', error);
            }
        }

        // Main function to check access and load content
        async function checkAccessAndLoadContent() {
            const overlay = document.getElementById('accessDeniedOverlay');
            const mainContent = document.getElementById('mainContent');
            const userIpDisplay = document.getElementById('userIpDisplay');

            // Immediately show the overlay and hide main content
            overlay.style.display = 'flex';
            mainContent.style.display = 'none';
            document.body.style.overflow = 'hidden'; // Prevent scrolling while checking

            await fetchAllowedIPs(); // Fetch allowed IPs first

            const userIP = await getUserIP();
            userIpDisplay.textContent = userIP || "Unknown"; // Display user's IP on the overlay

            if (userIP && allowedIPs.has(userIP)) {
                console.log("Access Granted for IP:", userIP);
                overlay.style.display = 'none'; // Hide overlay
                mainContent.style.display = 'block'; // Show main content
                document.body.style.overflow = ''; // Allow scrolling
                // Proceed with loading actual website content
                loadWebsiteContent();
            } else {
                console.warn("Access Denied for IP:", userIP || "Unknown IP");
                // The overlay is already visible, main content remains hidden
            }
        }

        // Existing function to load website content (now called after IP check)
        async function loadWebsiteContent() {
             Promise.all([
                fetch(sheetUrl).then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.text();
                }),
                fetchTestStatuses() // Changed function name
            ])
            .then(([csvText]) => {
                allData = parseCSV(csvText);
                testNames = allData.map(item => ({
                    name: item['name'] || '',
                    subname: item['subname'] || '',
                    price: item['price'] || '',
                    tubes: item['tubes'] || '',
                    method: item['method'] || '',
                    classes: item['classes'] || '',
                    fullItem: item
                })).filter(item => item.name);

                // Initialize Bootstrap components after content is loaded and visible
                initializeBootstrapComponents();
                populateUnavailableTestsPopover(); // This depends on unavailableTests and testStatus being populated
            })
            .catch(error => {
                document.getElementById('singleCardContainer').innerHTML = '<div class="text-danger">Error loading data. Please try again later.</div>';
                console.error('Error fetching CSV:', error);
            });
        }


        // --- Your existing data fetching and card display logic (mostly unchanged) ---
        function getRandomTestNames(count) {
            if (testNames.length === 0) return [];
            // No longer filtering out unavailable tests here, show all random tests
            const shuffled = [...testNames].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // Renamed from fetchUnavailableTests to fetchTestStatuses
        async function fetchTestStatuses() {
            try {
                console.log("Fetching test statuses from URL:", unavailableTestsUrl); // Added log
                const response = await fetch(unavailableTestsUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                console.log("Raw CSV text from test statuses URL:", csvText); // Added log for raw CSV

                const rows = csvText.trim().split('\n');
                const headers = rows[0].split(',').map(h => h.trim());

                console.log("Test Statuses Sheet Headers:", headers); // Log headers

                const nameIndex = headers.indexOf('Test Name');
                const statusIndex = headers.indexOf('Status');

                if (nameIndex === -1 || statusIndex === -1) {
                    console.warn("'Test Name' or 'Status' column not found in test statuses sheet. Cannot determine test statuses.");
                    return;
                }

                // Clear previous data
                unavailableTests.clear();
                testStatus.clear();

                rows.slice(1).forEach((row, index) => {
                    const values = row.split(',');
                    const testName = values[nameIndex] ? values[nameIndex].trim() : '';
                    const status = values[statusIndex] ? values[statusIndex].trim() : '';

                    console.log(`Row ${index + 1}: Test Name='${testName}', Status='${status}'`); // Log each row's data

                    if (testName) {
                        testStatus.set(testName, status); // Store the status
                        // Update unavailableTests set for backward compatibility with older logic if needed
                        if (status === 'Unavailable') { // Changed 'Not Available' to 'Unavailable'
                            unavailableTests.add(testName);
                            console.log(`Added to unavailableTests: ${testName}`);
                        }
                    }
                });
                console.log("Final Test Statuses Loaded:", Array.from(testStatus.entries()));
                console.log("Final Unavailable Tests Loaded (for badge count):", Array.from(unavailableTests));
            } catch (error) {
                console.error('Error fetching test statuses CSV from Sheet3:', error);
            }
        }

        function parseCSV(text) {
            const rows = text.trim().split('\n');
            const headers = rows[0].split(',').map(h => h.trim());
            const data = rows.slice(1).map(row => {
                const values = row.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
            return data;
        }

        function showCard(item) {
            console.log("showCard: Updating singleCardContainer for:", item.name); // Log when showCard is called
            const currentTestStatus = testStatus.get(item['name']) || '';

            const priceFormatted = item['price']
                ? item['price'].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' IQD'
                : '';

            const hasLink = item['link'] && item['link'].trim() !== '';

            const isFinishtimeNemawa = item['finishtime'] && item['finishtime'].trim() === 'نەماوە';
            const finishtimeClass = isFinishtimeNemawa ? 'bg-danger text-white p-2 rounded' : '';

            let statusAlertHtml = '';
            if (currentTestStatus === 'Unavailable') { // Changed 'Not Available' to 'Unavailable'
                statusAlertHtml = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i> This test is currently unavailable.
                    </div>
                `;
            } else if (currentTestStatus === 'Sent Out') {
                statusAlertHtml = `
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-truck me-2"></i> This test is sent out to another lab.
                    </div>
                `;
            }

            const container = document.getElementById('singleCardContainer');
            container.innerHTML = `
               <div class="card">
    <div class="card-header "> <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 d-inline"><strong>${item['name'] || 'No Name'}</strong></h5>
                </div>
            <div class="btn-group" role="group" aria-label="Basic outlined example">
                <button type="button" class="btn btn-outline-secondary" id="aboutBtn">About</button>
                <button type="button" class="btn btn-outline-secondary" id="prepBtn">Preparation</button>
            </div>
        </div>
        ${item['subname'] ? `<small class="d-block text-muted fst-italic mt-1">${item['subname']}</small>` : ''}
    </div>
    <div class="card-body">
        ${statusAlertHtml}
        <div class="row mb-3 text-center d-flex align-items-center justify-content-center">
            <div class="col">
                <h6 class="mb-1">Price</h6>
                <p class="mb-0">${priceFormatted}</p>
            </div>
            <div class="col">
                <h6 class="mb-1">Tubes</h6>
                <div id="tubes-badges" class="d-flex flex-wrap"></div>
            </div>
            <div class="col">
                <h6 class="mb-1">Method</h6>
                <span class="badge rounded-pill bg-warning text-dark">${item['method'] || ''}</span>
            </div>
            <div class="col">
                <h6 class="mb-1">Classes</h6>
                <span class="badge rounded-pill bg-success ">${item['classes'] || ''}</span>
            </div>
            <div class="col">
                <h6 class="mb-1">Link</h6>
                ${hasLink ? `<a href="${item['link']}" target="_blank" class="badge rounded-pill bg-primary text-white text-decoration-none">Labels</a>` : ''}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col text-center">
               <h6 class="mb-1">Time Finishing</h6>
               <p class="mb-0 ${finishtimeClass}" dir="rtl">${item['finishtime'] ? item['finishtime'].replace(/\./g, '<br/>') : ''}</p>
            </div>
        </div>
        <div id="about" style="display: none;" dir="rtl">
        <hr></hr>
            <h6>دەربارەى پشکنینەکە</h6>
            <p style="text-align: justify;">${item['about'] ? item['about'].replace(/\./g, '. <br/>') : ''}</p>
        </div>
        <div id="prep" style="display: none;" dir="rtl">
        <hr></hr>
            <h6>ئامادەکارى بۆ پشکنینەکە</h6>
            <p style="text-align: justify;">${item['prep'] ? item['prep'].replace(/\./g, '. <br/>') : ''}</p>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between">
        <small >${item['author'] || ''} | ${item['publishDate'] || ''}</small>
        <small>Update date :${item['updateDate'] || ''}</small>
    </div>
    </div>
            `;

            setTimeout(() => {
                const aboutDiv = container.querySelector('#about');
                const prepDiv = container.querySelector('#prep');
                const aboutBtn = container.querySelector('#aboutBtn');
                const prepBtn = container.querySelector('#prepBtn');

                const toggleSection = (targetDiv, button) => {
                    if (targetDiv.style.display === 'block') {
                        targetDiv.style.display = 'none';
                        button.classList.remove('active');
                    } else {
                        aboutDiv.style.display = 'none';
                        prepDiv.style.display = 'none';
                        aboutBtn.classList.remove('active');
                        prepBtn.classList.remove('active');

                        targetDiv.style.display = 'block';
                        button.classList.add('active');
                    }
                };

                aboutBtn.onclick = () => toggleSection(aboutDiv, aboutBtn);
                prepBtn.onclick = () => toggleSection(prepDiv, prepBtn);
            }, 0);

            generateTubeBadges(item['tubes']);
        }
        function generateTubeBadges(tubesStr) {
            const container = document.querySelector('#singleCardContainer #tubes-badges');
            if (!container) return;
            container.innerHTML = '';

            if (!tubesStr) return;

            const tubesArray = tubesStr.split('-').map(t => t.trim());
            tubesArray.forEach(tube => {
                const parts = tube.split(' ');
                const tubeNumber = parts.pop();
                const tubeName = parts.join(' ');

                let colorClass = '';
                if (/Gel/i.test(tubeName)) colorClass = 'bg-gel';
                else if (/EDTA/i.test(tubeName)) colorClass = 'bg-edta';
                else if (/SodiumCitrate/i.test(tubeName)) colorClass = 'bg-sodiumcitrate';
                else if (/Plane/i.test(tubeName)) colorClass = 'bg-plane';
                else if (/SodiumHeparin/i.test(tubeName)) colorClass = 'bg-sodiumheparin';
                else if (/LithiumHeparin/i.test(tubeName)) colorClass = 'bg-lithiumheparin';
                else if (/BigCup/i.test(tubeName)) colorClass = 'bg-bigcup';
                else colorClass = 'bg-other';

                const badge = document.createElement('span');
                badge.className = `badge rounded-pill ${colorClass} me-1`;
                badge.textContent = tubeNumber;
                container.appendChild(badge);
            });
        }

        // --- JavaScript for the new integrated search design ---
        const searchInput = document.getElementById('testSearch');
        const integratedSearchCard = document.getElementById('integratedSearchCard');
        const suggestionsBox = document.getElementById('suggestions');
        const clearBtn = document.getElementById('clearSearch');
        const singleCardContainer = document.getElementById('singleCardContainer');
        const suggestionsFooter = document.getElementById('suggestionsFooter');

        let debounceTimeout;

        function expandIntegratedCard() {
            if (!integratedSearchCard.classList.contains('expanded')) {
                integratedSearchCard.classList.add('expanded');
            }
        }

        function collapseIntegratedCard() {
            if (integratedSearchCard.classList.contains('expanded')) {
                integratedSearchCard.classList.remove('expanded');
                suggestionsBox.innerHTML = '';
                if (suggestionsFooter) {
                    suggestionsFooter.style.display = 'none';
                }
            }
            clearBtn.classList.remove('visible');
        }

        function toggleClearButtonVisibility() {
            if (searchInput.value.length > 0 || searchInput === document.activeElement) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
        }


        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            collapseIntegratedCard();
            singleCardContainer.innerHTML = '';
            searchInput.focus();
            toggleClearButtonVisibility();
        });

        // Modified focus event listener
        searchInput.addEventListener('focus', () => {
            // Only display default suggestions if the search input is empty
            if (searchInput.value === '') {
                displayDefaultSuggestions();
            } else {
                // If there's already text, show all relevant suggestions (no filtering for availability here)
                const q = searchInput.value.toLowerCase();
                const filtered = testNames.filter(
                    item => item.name.toLowerCase().includes(q) || (item.subname && item.subname.toLowerCase().includes(q))
                );
                showFilteredSuggestions(filtered);
            }
            toggleClearButtonVisibility();
        });

        searchInput.addEventListener('blur', (event) => {
            // Use a small timeout to allow click events on suggestions to register
            setTimeout(() => {
                // Check if the related target (where focus is moving to) is outside the search card
                // This prevents collapsing if clicking on a suggestion item within the card
                if (!integratedSearchCard.contains(document.activeElement)) {
                    collapseIntegratedCard();
                }
                toggleClearButtonVisibility(); // Keep clear button visible if search bar has content
            }, 100);
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const q = searchInput.value.toLowerCase();
                if (q) {
                    // Show all relevant suggestions (no filtering for availability here)
                    const filtered = testNames.filter(
                        item => item.name.toLowerCase().includes(q) || (item.subname && item.subname.toLowerCase().includes(q))
                    );
                    showFilteredSuggestions(filtered);
                } else {
                    // If input is cleared, show default suggestions again
                    displayDefaultSuggestions();
                }
                toggleClearButtonVisibility();
            }, 300);
        });

        function createBadge(text, colorClass = 'bg-secondary') {
            if (!text) return null;
            const badge = document.createElement('span');
            badge.className = `badge rounded-pill ${colorClass}`;
            badge.textContent = text;
            return badge;
        }

        function createSuggestionItem(item, iconClass = null) {
            const btn = document.createElement('span');
            btn.type = 'span';
            btn.className = 'suggestion-item';
            btn.setAttribute('aria-label', `Select ${item.name}`);

            const row1 = document.createElement('div');
            row1.className = 'suggestion-item-row-1';

            const nameElement = document.createElement('strong');
            nameElement.textContent = item.name;
            row1.appendChild(nameElement);

            const infoPillsDiv = document.createElement('div');
            infoPillsDiv.className = 'suggestion-info-pills';

            // Always add badges for price, method, classes, and tubes
            const priceBadge = createBadge(item.price + ' IQD', 'text-white bg-dark');
            if (priceBadge) infoPillsDiv.appendChild(priceBadge);

            const methodBadge = createBadge(item.method, 'bg-warning text-dark');
            if (methodBadge) infoPillsDiv.appendChild(methodBadge);

            const classesBadge = createBadge(item.classes, 'bg-success');
            if (classesBadge) infoPillsDiv.appendChild(classesBadge);

            if (item.tubes) {
                const tubesArray = item.tubes.split('-').map(t => t.trim());
                tubesArray.forEach(tube => {
                    const parts = tube.split(' ');
                    const tubeNumber = parts.pop();
                    const tubeName = parts.join(' ');

                    let colorClass = 'bg-secondary';
                    if (/Gel/i.test(tubeName)) colorClass = 'bg-gel';
                    else if (/EDTA/i.test(tubeName)) colorClass = 'bg-edta';
                    else if (/SodiumCitrate/i.test(tubeName)) colorClass = 'bg-sodiumcitrate';
                    else if (/Plane/i.test(tubeName)) colorClass = 'bg-plane';
                    else if (/SodiumHeparin/i.test(tubeName)) colorClass = 'bg-sodiumheparin';
                    else if (/LithiumHeparin/i.test(tubeName)) colorClass = 'bg-lithiumheparin';
                    else if (/BigCup/i.test(tubeName)) colorClass = 'bg-bigcup';

                    const tubeBadge = createBadge(tubeNumber, colorClass);
                    if (tubeBadge) infoPillsDiv.appendChild(tubeBadge);
                });
            }


            row1.appendChild(infoPillsDiv);
            btn.appendChild(row1);

            if (item.subname) {
                const row2 = document.createElement('div');
                row2.className = 'suggestion-item-row-2';
                const subnameElement = document.createElement('small');
                subnameElement.textContent = item.subname;
                row2.appendChild(subnameElement);
                btn.appendChild(row2);
            }

            // Always set the onclick handler, and stop propagation
            btn.onclick = (event) => {
                console.log("Suggestion item clicked for:", item.name); // Log click
                event.stopPropagation(); // Prevent the click from bubbling up and closing the suggestions prematurely
                searchInput.value = item.name;
                collapseIntegratedCard();
                console.log("Calling showCard with item:", item.fullItem); // Log before calling showCard
                showCard(item.fullItem);
            };

            return btn;
        }

        function updateSuggestionsFooter(totalCount) {
            if (suggestionsFooter) {
                // Display total number of tests (not just available ones)
                suggestionsFooter.textContent = `Total tests: ${totalCount}`;
                suggestionsFooter.style.display = 'block';
            }
        }

        function showFilteredSuggestions(suggestions) {
            suggestionsBox.innerHTML = '';
            const maxSuggestions = 5;

            // No longer filtering out unavailable tests here, show all
            if (suggestions.length === 0) {
                suggestionsBox.innerHTML = '<span class="suggestion-item text-muted disabled">No results found.</span>';
            } else {
                suggestions.slice(0, maxSuggestions).forEach(item => {
                    suggestionsBox.appendChild(createSuggestionItem(item));
                });
            }
            updateSuggestionsFooter(testNames.length); // Show total from allData
            expandIntegratedCard();
        }

        function displayDefaultSuggestions() {
            suggestionsBox.innerHTML = '';
            // No longer filtering out unavailable tests here, pick random from all
            const randomTests = getRandomTestNames(5);
            if (randomTests.length > 0) {
                randomTests.forEach(item => {
                    suggestionsBox.appendChild(createSuggestionItem(item));
                });
            } else {
                suggestionsBox.innerHTML = '<span class="suggestion-item text-muted disabled">Loading... If tests don\'t show, try clicking the search box again.</span>';
            }
            updateSuggestionsFooter(testNames.length); // Show total from allData
            expandIntegratedCard();
        }

        function populateUnavailableTestsPopover() {
            const unavailableTestsBadge = document.getElementById('unavailableTestsBadge');
            const popoverTrigger = document.getElementById('unavailableTestsPopoverTrigger');

            let popoverContentHtml = '';

            const unavailable = [];
            const sentOut = [];

            testStatus.forEach((status, testName) => {
                if (status === 'Unavailable') { // Changed 'Not Available' to 'Unavailable'
                    unavailable.push(testName);
                } else if (status === 'Sent Out') {
                    sentOut.push(testName);
                }
            });

            const totalSpecialTests = unavailable.length + sentOut.length;

            if (totalSpecialTests === 0) {
                popoverContentHtml = '<p class="text-muted mb-0">No special status tests.</p>';
                unavailableTestsBadge.classList.add('visually-hidden');
                unavailableTestsBadge.textContent = '0';
            } else {
                unavailableTestsBadge.classList.remove('visually-hidden');
                unavailableTestsBadge.textContent = totalSpecialTests.toString();

                let listItemsHtml = '';

                if (unavailable.length > 0) {
                    const sortedUnavailable = unavailable.sort((a, b) => a.localeCompare(b));
                    listItemsHtml += '<h6><i class="fas fa-times-circle text-danger me-2"></i>Unavailable Tests</h6><ul>';
                    listItemsHtml += sortedUnavailable.map(testName =>
                        `<li style="cursor: pointer;" data-test-name="${testName}" class="popover-list-item">${testName}</li>`
                    ).join('<hr>');
                    listItemsHtml += '</ul>';
                }

                if (sentOut.length > 0) {
                    if (unavailable.length > 0) {
                        listItemsHtml += '<hr>'; // Separator if both sections exist
                    }
                    const sortedSentOut = sentOut.sort((a, b) => a.localeCompare(b));
                    listItemsHtml += '<h6><i class="fas fa-truck text-warning me-2"></i>Sent Out Tests</h6><ul>';
                    listItemsHtml += sortedSentOut.map(testName =>
                        `<li style="cursor: pointer;" data-test-name="${testName}" class="popover-list-item">${testName}</li>`
                    ).join('<hr>');
                    listItemsHtml += '</ul>';
                }

                popoverContentHtml = listItemsHtml;
            }

            if (popoverTrigger) {
                popoverTrigger.setAttribute('data-bs-content', popoverContentHtml);

                if (!unavailableTestsPopoverInstance) {
                    unavailableTestsPopoverInstance = new bootstrap.Popover(popoverTrigger, {
                        trigger: 'hover',
                        delay: { "show": 100, "hide": 200 },
                        html: true
                    });
                     popoverTrigger.addEventListener('shown.bs.popover', attachPopoverItemClickListeners);
                } else {
                    unavailableTestsPopoverInstance.setContent({
                        '.popover-body': popoverContentHtml
                    });
                }
                attachPopoverItemClickListeners();
            }
        }

        function attachPopoverItemClickListeners() {
            const popoverBody = document.querySelector('.popover-body');
            if (popoverBody) {
                popoverBody.querySelectorAll('.popover-list-item').forEach(itemElement => {
                    itemElement.removeEventListener('click', handlePopoverItemClick); // Remove existing to prevent duplicates
                    itemElement.addEventListener('click', handlePopoverItemClick);
                });
            }
        }

        function handlePopoverItemClick(e) {
            const testName = e.target.getAttribute('data-test-name');
            if (testName) {
                const fullTestItem = allData.find(item => item.name === testName);
                if (fullTestItem) {
                    showCard(fullTestItem);
                    if (unavailableTestsPopoverInstance) {
                        unavailableTestsPopoverInstance.hide();
                    }
                }
            }
        }


        document.addEventListener('click', e => {
            // Only collapse if the click is outside the search card AND not on the search input itself
            if (!integratedSearchCard.contains(e.target) && e.target !== searchInput) {
                collapseIntegratedCard();
            }
        });

        toggleClearButtonVisibility();

        // Function to manually initialize Bootstrap Modals and attach event listeners
        function initializeBootstrapComponents() {
            const birthdateModalElement = document.getElementById('birthdateModal');
            const discountModalElement = document.getElementById('discountModal');

            // Initialize Modal instances
            birthdateModalInstance = new bootstrap.Modal(birthdateModalElement);
            discountModalInstance = new bootstrap.Modal(discountModalElement);

            // Attach click listeners to trigger elements
            const birthdateModalTrigger = document.getElementById('birthdateModalTrigger');
            if (birthdateModalTrigger) {
                birthdateModalTrigger.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default anchor behavior
                    birthdateModalInstance.show();
                });
            }

            const discountModalTrigger = document.getElementById('discountModalTrigger');
            if (discountModalTrigger) {
                discountModalTrigger.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default anchor behavior
                    discountModalInstance.show();
                });
            }
        }

        // Call checkAccessAndLoadContent on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            checkAccessAndLoadContent(); // This initiates the IP check and then loads content if allowed

            // Popover initialization is now handled within populateUnavailableTestsPopover
            // and initializeBootstrapComponents for consistency.
        });


        // --- Your existing modal JS functions (unchanged) ---
        function calculateBirthDate() {
            const currentDate = new Date();
            const years = parseInt(document.getElementById("yearsInput").value) || 0;
            const months = parseInt(document.getElementById("monthsInput").value) || 0;
            const days = parseInt(document.getElementById("daysInput").value) || 0;
            const birthDate = new Date(currentDate);
            birthDate.setFullYear(currentDate.getFullYear() - years);
            birthDate.setMonth(currentDate.getMonth() - months);
            birthDate.setDate(currentDate.getDate() - days);
            let day = birthDate.getDate();
            let month = birthDate.getMonth() + 1;
            let year = birthDate.getFullYear();
            document.getElementById("birthDateResult").textContent = `${day}/${month.toString().padStart(2, '0')}/${year}`;
        }

        var birthModal = document.getElementById('birthdateModal');
        birthModal.addEventListener('shown.bs.modal', function () {
            document.getElementById('yearsInput').focus();
        });

        function calculate() {
            var price = Number(document.discountCalculator.price.value);
            var discount = Number(document.discountCalculator.discount.value);
            var afterDiscount = price - (price * discount / 100);
            var disamount = price * discount / 100;
            document.discountCalculator.afterDiscount.value = Math.floor(afterDiscount);
            document.discountCalculator.disamount.value = Math.floor(disamount);
        }
        
        
       // JavaScript for fetching data and populating the new modal table
        document.getElementById("discountInstructionsLink").addEventListener("click", async function (event) {
            event.preventDefault();
            const tableBody = document.getElementById("discountTableBody");
            
            // Show loading message while fetching data
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading data...</td></tr>';
            
            // Construct the URL to fetch the Google Sheet data as a CSV
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/1GXf9_syNE-_CDVr1ljM_tSgSwOOMQ7PcNxamQp7BS40/gviz/tq?tqx=out:csv&gid=1101817678';

            try {
                const response = await fetch(sheetUrl);
                const csvText = await response.text();
                
                // Use a more robust regex to handle commas inside quotes
                const rows = csvText.split('\n').slice(1, 16); // Take the first 15 rows, skipping the header
                
                // Clear the loading message and previous data
                tableBody.innerHTML = '';
                
                rows.forEach(row => {
                    // This regex correctly splits the CSV row, ignoring commas inside double quotes
                    const columns = row.match(/(".*?"|[^",\s]+)(?=\s*\,|\s*$)/g).map(cell => cell.replace(/"/g, ''));
                    const tr = document.createElement('tr');
                    
                    // Ensure we only have 6 columns and sanitize the text
                    for (let i = 0; i < 6; i++) {
                        const td = document.createElement('td');
                        td.textContent = columns[i] ? columns[i] : '';
                        tr.appendChild(td);
                    }
                    tableBody.appendChild(tr);
                });

                // Add two new rows with colspan="6" for summary
                const firstColspanRow = document.createElement('tr');
                const firstColspanTd = document.createElement('td');
                firstColspanTd.setAttribute('colspan', '6');
                firstColspanTd.textContent = 'ئەو بەشەى کە هێماى (*) لێدراوە داشکاندن بۆ کارمەندى بەشەکانیان دەبێت دوو لەوەندەى ئەوەى لەڕێنماییەکە ئاماژەى پێداراوە';
                firstColspanRow.appendChild(firstColspanTd);
                tableBody.appendChild(firstColspanRow);

               

                // Show the modal after data is populated
                const discountModal = new bootstrap.Modal(document.getElementById('discountModal'));
                discountModal.show();

            } catch (error) {
                console.error("Error fetching or parsing data:", error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">Failed to load data. Please try again later.</td></tr>';
                // Still show the modal even if there's an error
                const discountModal = new bootstrap.Modal(document.getElementById('discountModal'));
                discountModal.show();
            }
        });
    </script>
</body>
</html>

